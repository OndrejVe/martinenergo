<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Energo – testovací chat</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 24px; background:#fafafa; }
    h1 { margin: 0 0 16px; }
    .row { display: flex; gap: 8px; }
    input[type="text"] { flex: 1; padding: 12px; font-size: 16px; }
    button { padding: 12px 16px; font-size: 16px; cursor: pointer; }
    .card { background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 16px; margin-top: 12px; }
    .muted { color: #666; font-size: 14px; }
    .sources a { display:block; color:#0b57d0; text-decoration:none; margin:4px 0; }
    .error { color: #b00020; }
    .preview img { max-width: 100%; height: auto; display:block; margin: 8px 0; }
    .preview embed { width:100%; height:480px; border:none; margin: 8px 0; }
    #chart { width: 100%; height: 320px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Energo – testovací chat</h1>

  <div class="row">
    <input id="q" type="text" placeholder="Zeptej se…" />
    <button id="send">Poslat</button>
    <input id="file" type="file" />
  </div>

  <div id="out" class="card muted">Výstup se objeví zde…</div>
  <div id="src" class="card sources" style="display:none"></div>
  <div id="chartCard" class="card" style="display:none">
    <canvas id="chart"></canvas>
  </div>
  <div id="preview" class="card preview" style="display:none"></div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const api = (path) => `${location.origin}${path}`;

    let chart; // držák na instanci grafu

    async function ask() {
      const q = $("#q").value.trim();
      if (!q) return;
      $("#out").textContent = "⏳ Přemýšlím…";
      $("#src").style.display = "none";
      $("#chartCard").style.display = "none";
      $("#preview").style.display = "none";

      try {
        const r = await fetch(api("/chat"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ q }),
        });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();

        // Textová odpověď
        $("#out").classList.remove("error");
        $("#out").innerHTML = (data.answer || "").replaceAll("\n", "<br>");

        // Zdroje (očekávám list typu [{url, title}] – toleruje i prosté stringy)
        const src = data.sources || [];
        if (src.length) {
          const html = src.map(s => {
            if (typeof s === "string") return `<a href="${s}" target="_blank">${s}</a>`;
            const t = s.title || s.url || "zdroj";
            const u = s.url || "#";
            return `<a href="${u}" target="_blank">${t}</a>`;
          }).join("");
          $("#src").innerHTML = "<strong>Zdroje:</strong><br>" + html;
          $("#src").style.display = "block";
        }

        // Graf (očekává { type, labels, data })
        if (data.chart && Array.isArray(data.chart.labels) && Array.isArray(data.chart.data)) {
          const ctx = document.getElementById("chart").getContext("2d");
          if (chart) chart.destroy();
          chart = new Chart(ctx, {
            type: data.chart.type || "bar",
            data: {
              labels: data.chart.labels,
              datasets: [{ label: data.chart.title || "Graf", data: data.chart.data }]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });
          $("#chartCard").style.display = "block";
        }

        // Náhled vloženého souboru (když backend vrátí třeba {previewUrl: "/web/uploads/file.pdf"})
        if (data.previewUrl) {
          const url = data.previewUrl;
          const holder = $("#preview");
          holder.innerHTML = "";
          if (/\.(png|jpe?g|gif|webp|svg)$/i.test(url)) {
            const img = new Image(); img.src = url; holder.appendChild(img);
          } else if (/\.pdf$/i.test(url)) {
            const em = document.createElement("embed");
            em.src = url; em.type = "application/pdf";
            holder.appendChild(em);
          } else {
            holder.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
          }
          holder.style.display = "block";
        }

      } catch (e) {
        $("#out").classList.add("error");
        $("#out").textContent = "Chyba: " + e.message;
      }
    }

    async function uploadFile() {
      const f = $("#file").files?.[0];
      if (!f) return;
      const fd = new FormData(); fd.append("file", f);
      const r = await fetch(api("/upload"), { method: "POST", body: fd });
      if (!r.ok) { alert("Nahrání selhalo"); return; }
      const resp = await r.json();
      $("#preview").style.display = "block";
      $("#preview").innerHTML = `<div class="muted">Nahráno: <a target="_blank" href="${resp.url}">${resp.url}</a></div>`;
    }

    $("#send").addEventListener("click", ask);
    $("#q").addEventListener("keydown", (e) => { if (e.key === "Enter") ask(); });
    $("#file").addEventListener("change", uploadFile);
  </script>
</body>
</html>
